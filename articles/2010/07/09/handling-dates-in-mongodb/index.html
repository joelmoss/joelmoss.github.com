
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Handling Dates in MongoDB - Develop With Style</title>
  <meta name="author" content="Joel Moss">

  
  <meta name="description" content="I&#8217;ve been using MongoDB quite a bit recently in several different projects, and it kicks ass. But the hardest thing to learn and to get used to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://developwithstyle.com/articles/2010/07/09/handling-dates-in-mongodb">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/DevelopingWithStyle" rel="alternate" title="Develop With Style" type="application/atom+xml">
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Actor|Quattrocento+Sans' rel='stylesheet' type='text/css'>

<style type="text/css" media="screen">
  .carbonad {
    width: 265px !important;
    height: 98px !important;
  }
  .carbonad-text {
    width: 136px !important;
    padding-top: 8px !important;
  }
  .carbonad-image img {
    width: 110px !important;
    height: 80px !important;
  }
  .carbonad-tag {
    width: 136px !important;
  }
</style>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-9843082-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body  >
  <nav role=navigation><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/DevelopingWithStyle" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:developwithstyle.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul role=main-navigation>
  <li><a href="/">Home</a></li>
  <li><a href="/#contact">Contact</a></li>
  <li><a href="/articles">Blog</a></li>
  <li><a href="http://github.com/joelmoss">Github</a></li>
  <li><a href="http://twitter.com/joelmoss">Twitter</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <header><hgroup>
  <h1><a href="/">Develop With Style</a></h1>
</hgroup>

</header>
      <div>
<article class="hentry">
  
  <header>
    
      <h1 class="entry-title">Handling Dates in MongoDB</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-07-09T00:00:00+01:00" pubdate data-updated="true">Jul 9<span>th</span>, 2010</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I&#8217;ve been using <a href="http://www.mongodb.org/">MongoDB</a> quite a bit recently in several different projects, and it kicks ass. But the hardest thing to learn and to get used to with Mongo, is it&#8217;s schemaless structure. With SQL databases like MySQL, you always have a defined and very rigid structure, which is of course the schema for each table you create. You create a table with a few columns; each column has a set type, a length, and a whole host of other variables.</p>




<p>It&#8217;s this rigid structure that most of us have gotten used to for years, and that is the hardest thing to shake off when using NoSQL databases such as MongoDB.</p>




<p>But that is not to say that Mongo has no defined structure. In fact, that is far from the truth. Mongo and all schemaless databases have defined structure, but the difference is that that structure is defined by you. And that is what makes Mongo so cool. No need to actually create any tables and define each column - Just insert some data in your own defined way.</p>




<p>But there is a side effect of this schemaless idea. Even though you no longer have to define a schema in the traditional sense, you still have to think about the structure of each collection, and how that will look. In fact, there is a lot more to think about, as there are a lot more ways to structure your data with Mongo and other schemaless databases.</p>




<p>It&#8217;s somewhat of a steep learning curve, but well worth sticking with. I&#8217;m still leaning the best ways to structure certain data types, and dates is one that I think I&#8217;ve nailed.</p>




<!--more-->




<p>Nearly all your collections will no doubt contain some sort of date or time stamp. While Mongo does have it&#8217;s own native <code>Date()</code> object, it&#8217;s only really useful within the Mongo shell. I need to use it within PHP and Ruby and other languages. Up until recently, I&#8217;ve been saving <code>datetime</code> as &#8221;<code>2010-07-09 13:56:31</code>&#8221;. This works fine most of the time, but when you start needing to gather your data in more advanced ways, it starts to fall apart.</p>




<p>For example, I&#8217;m currently using Mongo and the equally awesome <a href="http://code.google.com/p/redis/">Redis</a> for logging data for <a href="http://quicksearch.shermanstravel.com">ShermansTravel.com</a>. I needed to log a bunch of data each time a user clicks one of our paying ads. I ended up with collection records like this: (in PHP, as that is what this project calls for unfortunately)</p>




<div class="highlight"><pre><code class="javascript">
  {
    "_id" : ObjectId("4bfea7246c6151d127f80100"),
    "button_rank" : "5",
    "category" : "flights",
    "class" : "Economy",
    "cpc" : "0.17",
    "destination_place_id" : "197868",
    "from_code" : "ORD",
    "from_code_include_nearby" : false,
    "travelers" : "1",
    "created" : "2010-03-29 20:15:34"
  }
</code></pre></div>




<p>Notice the the <code>created</code> timestamp on the last line there. Nothing special there, and I can find by the <code>created</code> date without any issue at all. But I need to now count all clicks grouped by day, not time. This is where the above falls apart.</p>




<p>This is what I tried:</p>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">  $keys = new MongoCode(&#39;function(doc) { return { created: doc.created.split(&quot; &quot;)[0] }; }&#39;);</span>
</span><span class='line'><span class="x">  $reduce = new MongoCode(&#39;function(doc, prev) { prev.count++; }&#39;);</span>
</span><span class='line'><span class="x">  $clicks = $this-&gt;group($keys, array(&#39;count&#39; =&gt; 0), $reduce);</span>
</span></code></pre></td></tr></table></div></figure>




<p>Again, this works&#8230; almost! This week, the clicks collection ended up with 900,000 records, and using the above group query kept timing out. The problem is the second line where instead of simply specifying which key(s) to group by, I have to pass a PHP MongoCode object containing a Javascript function that creates and returns a custom key. In this case, I am simply grabbing the <code>created</code> key of each record, and splitting the string, so I have the date and the time. I then return the date only, and can now group by date. This means that Mongo is iterating over every record and applying that function to each one, which obviously can take some time on larger collections, and completely ignores any indexes you may have created.</p>




<p>So I quickly determined from this that I was storing the date and time in the wrong way. I need to split up the date and time. I now have this:</p>




<div class="highlight"><pre><code class="javascript">
  {
    "_id" : ObjectId("4bfea7246c6151d127f80100"),
    "button_rank" : "5",
    "category" : "flights",
    "class" : "Economy",
    "cpc" : "0.17"
    "destination_place_id" : "197868",
    "from_code" : "ORD",
    "from_code_include_nearby" : false,
    "travelers" : "1",
    "created" : { "d" : "2010-03-29", "t" : "20:15:34" }
  }
</code></pre></div>




<p>The last line still shows the <code>created</code> date and time, but instead stores each in an embedded object or hash. This means that I can still find by <code>created</code> date and time with just a little change, but more importantly, it means I can group much easier and much, much faster:</p>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">  $key = array(&#39;created.d&#39; =&gt; 1);</span>
</span><span class='line'><span class="x">  $reduce = new MongoCode(&#39;function(doc, prev) { prev.count++; }&#39;);</span>
</span><span class='line'><span class="x">  $clicks = $this-&gt;group($key, array(&#39;count&#39; =&gt; 0), $reduce);</span>
</span></code></pre></td></tr></table></div></figure>




<p>As you can from the second line in the above, I am no longer passing a function to build the key I want to group by - which was what was causing the problem. I now simply pass the key I want to group by: <code>created.d</code>. The code is leaner and the query is loads faster, and my indexes are respected.</p>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Joel Moss</span></span>

      








  



      

<span class="categories">
  
    <a class='category' href='/articles/categories/articles/'>articles</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://developwithstyle.com/articles/2010/07/09/handling-dates-in-mongodb/" data-via="joelmoss" data-counturl="http://developwithstyle.com/articles/2010/07/09/handling-dates-in-mongodb/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread"><div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'dws';
  var disqus_identifier = 'http://developwithstyle.com/articles/2010/07/09/handling-dates-in-mongodb/';
  var disqus_url = 'http://developwithstyle.com/articles/2010/07/09/handling-dates-in-mongodb/';
  //var disqus_developer = 1;
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside role=sidebar>
  
    <header><hgroup>
  <h1><a href="/">Develop With Style</a></h1>
</hgroup>

</header><section>
  <h1>About Me</h1>
  <p>This site contains the musings of Joel Moss, a web developer of some 13 years; living in Manchester, England. But some say I'm physically plugged into, and live IN the internet! They may actually be right!</p>
  <p><a href="/">Tell me more...</a></p>
</section>
<div id="carbonads-container"><div class="carbonad"><div id="carbon"></div><script type="text/javascript">var z = document.createElement("script"); z.type = "text/javascript"; z.async = true; z.src = "http://engine.carbonads.com/z/12107/carbon_2_1_0_HORIZ"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(z, s);</script></div></div> <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/articles/2012/06/22/speeding-up-sql-queries-containing-text-fields/">Speeding up SQL queries containing TEXT fields</a>
      </li>
    
      <li class="post">
        <a href="/articles/2012/05/23/lessons-learnt-from-building-a-rest-based-api/">Lessons learnt from building a REST API</a>
      </li>
    
      <li class="post">
        <a href="/articles/2011/07/12/the-right-way-to-create-an-api/">The Right Way to Create an API</a>
      </li>
    
      <li class="post">
        <a href="/articles/2010/10/28/from-zero-to-hero-how-i-built-twitious-in-two-weeks/">From Zero to Hero: How I built Twitious in Two Weeks</a>
      </li>
    
      <li class="post">
        <a href="/articles/2010/08/09/dynamic-form-and-dynamic-errors-for-rails-3/">Dynamic Form and Dynamic Errors for Rails 3</a>
      </li>
    
      <li class="post">
        <a href="/articles/2010/07/09/handling-dates-in-mongodb/">Handling Dates in MongoDB</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("joelmoss", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/joelmoss" class="twitter-follow-button" data-show-count="true">Follow @joelmoss</a>
  
</section>



  
</aside>


    </div>
  </div>
  <footer><p>
  Developed with Style - &copy; 2012 - Joel Moss
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dws';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
