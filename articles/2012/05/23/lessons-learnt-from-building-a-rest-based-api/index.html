
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Lessons learnt from building a REST API - Develop With Style</title>
  <meta name="author" content="Joel Moss">

  
  <meta name="description" content="Late last year, I built a REST based API for ShermansTravel using Rails and ActsAsAPI. The API allowed us to tag and/or geotag any object, and was &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://developwithstyle.com/articles/2012/05/23/lessons-learnt-from-building-a-rest-based-api">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/DevelopingWithStyle" rel="alternate" title="Develop With Style" type="application/atom+xml">
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Actor|Quattrocento+Sans' rel='stylesheet' type='text/css'>

<style type="text/css" media="screen">
  .carbonad {
    width: 265px !important;
    height: 98px !important;
  }
  .carbonad-text {
    width: 136px !important;
    padding-top: 8px !important;
  }
  .carbonad-image img {
    width: 110px !important;
    height: 80px !important;
  }
  .carbonad-tag {
    width: 136px !important;
  }
</style>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-9843082-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body  >
  <nav role=navigation><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/DevelopingWithStyle" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:developwithstyle.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul role=main-navigation>
  <li><a href="/">Home</a></li>
  <li><a href="/#contact">Contact</a></li>
  <li><a href="/articles">Blog</a></li>
  <li><a href="http://github.com/joelmoss">Github</a></li>
  <li><a href="http://twitter.com/joelmoss">Twitter</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <header><hgroup>
  <h1><a href="/">Develop With Style</a></h1>
</hgroup>

</header>
      <div>
<article class="hentry">
  
  <header>
    
      <h1 class="entry-title">Lessons Learnt From Building a REST API</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-23T00:00:00+01:00" pubdate data-updated="true">May 23<span>rd</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Late last year, I built a REST based API for <a href="http://www.shermanstravel.com">ShermansTravel</a> using Rails and <a href="https://github.com/fabrik42/acts_as_api">ActsAsAPI</a>. The API allowed us to tag and/or geotag any object, and was backed with <a href="http://mongodb.org">MongoDB</a> and a little MySQL for authentication. The API itself was - and still is - sound, but unfortunately it turned out to be very slow. This was amplified even further due to its use by another REST based API.</p>

<p>These last few weeks have allowed me to revisit the application, and to make changes to speed things up, often-times resulting in a 400% speed increase, not to mention increased concurrency. This post will briefly detail the lessons learnt building a high trafficked API, and what changes I have made.</p>

<!-- more -->


<p>Please note, that this post is very Ruby-centric, so only considers what is available to the Rubyist.</p>

<h3>1. Don&#8217;t use Rails</h3>

<p>Rails is awesome&#8230; for most things. But when you don&#8217;t need any views or assets, or when you are not building a traditional web application, it&#8217;s overkill. And you&#8217;ll soon start finding that your app is slow. You have to remember that Rails is a full stack framework, but your API is most likely not.</p>

<p>If you really have to use a Framework, check out <a href="http://sinatrarb.com">Sinatra</a>, which has a much smaller footprint. Or peel it back even further, and create a bare bones Rack app. Which is a lot easier than you might think.</p>

<h3>2. Don&#8217;t use ActiveRecord</h3>

<p>I hate to say this, but ActiveRecord is slow! In fact, most ORM&#8217;s are usually much, much slower than using raw SQL. However, if your API uses MySQL heavily, you may not want to write the SQL yourself, and enjoy the huge conveniance that AR gives you. But you may be surprised how you can build yourself a little code that emulates a little of the AR API.</p>

<p>For example, in my API rewrite, I can still do this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">deal</span> <span class="o">=</span> <span class="no">Deal</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">deal</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;category = &#39;hotel&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;created_at DESC&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">deal</span><span class="o">.</span><span class="n">run_query</span>
</span></code></pre></td></tr></table></div></figure>


<p>And this is my <code>Deal</code> model:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Deal</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">where</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@where_array</span> <span class="o">||=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="vi">@where_array</span> <span class="o">&lt;&lt;</span> <span class="n">sql</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@select_array</span> <span class="o">||=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="vi">@select_array</span> <span class="o">&lt;&lt;</span> <span class="n">sql</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">joins</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@joins_array</span> <span class="o">||=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="vi">@joins_array</span> <span class="o">&lt;&lt;</span> <span class="n">sql</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@order_array</span> <span class="o">||=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="vi">@order_array</span> <span class="o">&lt;&lt;</span> <span class="n">sql</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Run the SQL query.</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">run_query</span>
</span><span class='line'>    <span class="n">connection</span><span class="o">.</span><span class="n">query</span> <span class="n">build_sql</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Builds the full SQL query.</span>
</span><span class='line'>    <span class="c1">#</span>
</span><span class='line'>    <span class="c1"># Returns the SQL statement as a String.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">build_sql</span>
</span><span class='line'>      <span class="n">_select</span> <span class="o">=</span> <span class="vi">@select_array</span> <span class="o">||</span> <span class="o">[</span><span class="s1">&#39;*&#39;</span><span class="o">]</span>
</span><span class='line'>      <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT </span><span class="si">#{</span><span class="n">_select</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> FROM `places` &quot;</span>
</span><span class='line'>      <span class="n">sql</span> <span class="o">&lt;&lt;</span> <span class="vi">@joins_array</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">unless</span> <span class="vi">@joins_array</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>      <span class="n">sql</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot; WHERE </span><span class="si">#{</span><span class="vi">@where_array</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; AND &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">unless</span> <span class="vi">@where_array</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>      <span class="n">sql</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot; ORDER BY </span><span class="si">#{</span><span class="vi">@order_array</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">unless</span> <span class="vi">@order_array</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">unset_sql_variables</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">sql</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">unset_sql_variables</span>
</span><span class='line'>      <span class="vi">@where_array</span><span class="p">,</span> <span class="vi">@select_array</span><span class="p">,</span> <span class="vi">@joins_array</span><span class="p">,</span> <span class="vi">@order_array</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">connection</span>
</span><span class='line'>      <span class="c1"># your database connection</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Very basic, but does the job nicely. My <code>connection</code> method simply uses the <a href="https://github.com/brianmario/mysql2">MySQL2</a> Ruby Gem, which has very little overhead.</p>

<h3>3. Increase concurrency and use EventMachine</h3>

<p>This one is a biggie, but an absolute must, and is the biggest performance boost I have received so far.</p>

<p><a href="http://rubyeventmachine.com/">EventMachine</a> is a fast, simple event-processing library in a similar vein to Node.JS. But it&#8217;s all Ruby! It allows you to take advantage of threaded network programming, thus increasing concurrency, scalability and performance.</p>

<p>Unfortunately, it has also involved some considerable rewriting, to ensure that my code is thread-safe, and that I take advantage of EventMachine as much as I can. However, the benefits have far exceeded this small cost. In fact, I now have a much smaller footprint all over my code, which also helps.</p>

<p>Not to get too specific, but my rewritten API uses the excellent <a href="http://postrank-labs.github.com/goliath/">Goliath</a> Ruby web server, along with the em-synchrony, em-http-request and em-mongo gems to help me make my API asynchronous. And fast!</p>

<h3>4. Use JSON&#8230; everywhere!</h3>

<p>There is a reason why JSON is now almost the data format of the web. It&#8217;s lightweight, simple and fast. And Ruby support for it is top-notch. Just add the <a href="https://github.com/intridea/multi_json">MultiJson</a> and <a href="https://github.com/ohler55/oj">OJ</a> gems to your Gemfile, and you won&#8217;t get much faster.</p>

<p>Unless you have a real need to use XML or another data format, all you need is JSON.</p>

<h4>In Conclusion&#8230;</h4>

<p>There are obviously smaller things to think about when building an API, but the above four were the biggest changes I made to the API, and so far they have made a huge improvement.</p>

<p>Keep it mean, keep it lean, keep it kean!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Joel Moss</span></span>

      








  



      

<span class="categories">
  
    <a class='category' href='/articles/categories/articles/'>articles</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://developwithstyle.com/articles/2012/05/23/lessons-learnt-from-building-a-rest-based-api/" data-via="joelmoss" data-counturl="http://developwithstyle.com/articles/2012/05/23/lessons-learnt-from-building-a-rest-based-api/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread"><div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'dws';
  var disqus_identifier = 'http://developwithstyle.com/articles/2012/05/23/lessons-learnt-from-building-a-rest-based-api/';
  var disqus_url = 'http://developwithstyle.com/articles/2012/05/23/lessons-learnt-from-building-a-rest-based-api/';
  //var disqus_developer = 1;
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside role=sidebar>
  
    <header><hgroup>
  <h1><a href="/">Develop With Style</a></h1>
</hgroup>

</header><section>
  <h1>About Me</h1>
  <p>This site contains the musings of Joel Moss, a web developer of some 13 years; living in Manchester, England. But some say I'm physically plugged into, and live IN the internet! They may actually be right!</p>
  <p><a href="/">Tell me more...</a></p>
</section>
<div id="carbonads-container"><div class="carbonad"><div id="carbon"></div><script type="text/javascript">var z = document.createElement("script"); z.type = "text/javascript"; z.async = true; z.src = "http://engine.carbonads.com/z/12107/carbon_2_1_0_HORIZ"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(z, s);</script></div></div> <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/articles/2012/05/23/lessons-learnt-from-building-a-rest-based-api/">Lessons learnt from building a REST API</a>
      </li>
    
      <li class="post">
        <a href="/articles/2011/07/12/the-right-way-to-create-an-api/">The Right Way to Create an API</a>
      </li>
    
      <li class="post">
        <a href="/articles/2010/10/28/from-zero-to-hero-how-i-built-twitious-in-two-weeks/">From Zero to Hero: How I built Twitious in Two Weeks</a>
      </li>
    
      <li class="post">
        <a href="/articles/2010/08/09/dynamic-form-and-dynamic-errors-for-rails-3/">Dynamic Form and Dynamic Errors for Rails 3</a>
      </li>
    
      <li class="post">
        <a href="/articles/2010/07/09/handling-dates-in-mongodb/">Handling Dates in MongoDB</a>
      </li>
    
      <li class="post">
        <a href="/articles/2010/06/29/converting-html-entities-to-characters/">Converting HTML Entities to Characters with Javascript</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("joelmoss", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/joelmoss" class="twitter-follow-button" data-show-count="true">Follow @joelmoss</a>
  
</section>



  
</aside>


    </div>
  </div>
  <footer><p>
  Developed with Style - &copy; 2012 - Joel Moss
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'dws';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
